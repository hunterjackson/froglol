#!/bin/bash
#
# Pre-commit hook to run ruff for linting and formatting
# This hook automatically fixes and formats Python files before committing
#

set -e

echo "Running ruff checks and formatting..."

# Get list of staged Python files
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$STAGED_PY_FILES" ]; then
    echo "No Python files to check."
    exit 0
fi

echo "Checking and fixing Python files:"
echo "$STAGED_PY_FILES"

# Run ruff check with auto-fix on staged files
echo ""
echo "1. Running ruff check --fix..."
if ! uv run ruff check --fix $STAGED_PY_FILES; then
    echo ""
    echo "❌ Ruff check found issues that couldn't be auto-fixed."
    echo "   Please fix the issues manually and try again."
    exit 1
fi

# Run ruff format on staged files
echo ""
echo "2. Running ruff format..."
if ! uv run ruff format $STAGED_PY_FILES; then
    echo ""
    echo "❌ Ruff format failed."
    exit 1
fi

# Re-add files that were modified by ruff
echo ""
echo "3. Re-staging files modified by ruff..."
for file in $STAGED_PY_FILES; do
    if [ -f "$file" ]; then
        git add "$file"
        echo "   ✓ $file"
    fi
done

# Verify no linting issues remain (matches GitHub Actions)
echo ""
echo "4. Verifying all linting issues are resolved..."
if ! uv run ruff check app/ tests/; then
    echo ""
    echo "❌ Ruff check found issues that weren't fixed."
    echo "   This is what GitHub Actions will run and fail on."
    echo "   Please fix the issues manually and try again."
    exit 1
fi

# Verify formatting is correct (matches GitHub Actions)
echo ""
echo "5. Verifying formatting is correct..."
if ! uv run ruff format --check app/ tests/; then
    echo ""
    echo "❌ Ruff format check found issues."
    echo "   This is what GitHub Actions will run and fail on."
    echo "   Please run 'uv run ruff format app/ tests/' and try again."
    exit 1
fi

echo ""
echo "✅ All checks passed! Your code will pass GitHub Actions lint checks."
exit 0
